<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory</title>
    <style>
        :root { --primary: #007AFF; --danger: #FF3B30; --card-bg: #1c1c1e; --text: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: -apple-system, sans-serif; 
            background: #000000; color: var(--text); 
            height: 100vh;
        }
        
        header { 
            padding: 15px; display: flex; justify-content: space-between; align-items: center; 
            background: #000; position: sticky; top: 0; z-index: 100;
        }

        .container { 
            padding: 15px; 
            margin-top: 38px; /* 1cm gap from top */
            padding-bottom: 100px; 
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            overflow: hidden;
            border: 1px solid #333;
            height: 100px;
        }

        .card-img { 
            width: 100px; height: 100px; 
            background-size: cover; background-position: center; 
            flex-shrink: 0; background-color: #2c2c2e;
        }

        /* Middle section for Name and Mini-List */
        .card-content {
            flex: 1; height: 100%; display: flex; flex-direction: column;
            padding: 10px 15px; justify-content: center; overflow: hidden;
        }

        .card-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .preview-list {
            font-size: 11px; color: #888; display: flex; flex-wrap: wrap; gap: 5px;
            max-height: 40px; overflow: hidden;
        }

        .preview-item { background: #2c2c2e; padding: 2px 6px; border-radius: 4px; }

        /* Control Panel */
        .card-controls {
            display: flex; flex-direction: column; justify-content: space-around;
            align-items: center; padding: 5px; border-left: 1px solid #333;
            height: 100%; width: 50px; background: #121212;
        }

        .ctrl-btn { background: none; border: none; color: #007AFF; font-size: 16px; padding: 5px; cursor: pointer; }
        .ctrl-gear { color: #666; font-size: 18px; }

        .hidden { display: none !important; }
        .btn-mini { border: none; background: var(--primary); color: white; border-radius: 8px; padding: 10px 15px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: var(--danger); }
        
        .modal-bg { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index: 1000; }
        .modal-bg.active { display: flex; }
        .modal { background: #2c2c2e; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; }
        
        input { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #444; border-radius: 10px; background: #1c1c1e; color: white; font-size: 16px; }
        
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 99; }
    </style>
</head>
<body>

<header>
    <button id="back-btn" class="btn-mini hidden" style="background:#333" onclick="goBack()">← Back</button>
    <h2 id="title" style="margin:0;">Inventory</h2>
    <div style="width:40px"></div>
</header>

<div class="container" id="app-content"></div>

<button class="fab" id="main-fab" onclick="openAddModal()">+</button>

<div id="edit-modal" class="modal-bg">
    <div class="modal">
        <h3 id="edit-header">Edit Entry</h3>
        <input id="edit-name" placeholder="Name">
        <input id="edit-img" placeholder="Image URL">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-mini" style="flex:1" onclick="applyEdit()">Save</button>
            <button class="btn-mini btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
        <button class="btn-mini" style="width:100%; margin-top:10px; background:#444" onclick="closeModals()">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC2sZwT7PeKJHW9LJ4_xdxKMMVxZMrllWg",
        authDomain: "inventory-8a01f.firebaseapp.com",
        databaseURL: "https://inventory-8a01f-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "inventory-8a01f",
        storageBucket: "inventory-8a01f.firebasestorage.app",
        messagingSenderId: "759088447580",
        appId: "1:759088447580:web:5859088803734d62c2e699"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const invRef = ref(db, 'inventory/');

    let state = { folders: [] };
    let currentFolderId = null;
    let editingTarget = { type: null, idx: null };

    onValue(invRef, (snap) => {
        state = snap.val() || { folders: [] };
        render();
    });

    function sync() { set(invRef, state); }

    window.render = () => {
        const content = document.getElementById('app-content');
        const backBtn = document.getElementById('back-btn');
        content.innerHTML = '';

        if (currentFolderId === null) {
            backBtn.classList.add('hidden');
            document.getElementById('title').innerText = "Inventory";
            state.folders.forEach((f, idx) => {
                const itemsList = (f.items || []).slice(0, 4).map(i => `<span class="preview-item">${i.name}</span>`).join('');
                content.innerHTML += `
                <div class="card">
                    <div class="card-img" style="background-image:url('${f.img}')" onclick="openFolder(${f.id})"></div>
                    <div class="card-content" onclick="openFolder(${f.id})">
                        <div class="card-name">${f.name}</div>
                        <div class="preview-list">${itemsList || 'Empty'}</div>
                    </div>
                    <div class="card-controls">
                        <button class="ctrl-btn" onclick="move('f', ${idx}, -1)">▲</button>
                        <button class="ctrl-btn ctrl-gear" onclick="openEditModal('f', ${idx})">⚙️</button>
                        <button class="ctrl-btn" onclick="move('f', ${idx}, 1)">▼</button>
                    </div>
                </div>`;
            });
        } else {
            backBtn.classList.remove('hidden');
            const folder = state.folders.find(f => f.id === currentFolderId);
            document.getElementById('title').innerText = folder.name;
            content.innerHTML = `<button class="btn-mini" style="width:100%; margin-bottom:20px;" onclick="openAddModal()">+ Add New Item</button>`;
            (folder.items || []).forEach((item, idx) => {
                content.innerHTML += `
                <div class="card">
                    <div class="card-img" style="background-image:url('${item.img}')"></div>
                    <div class="card-content">
                        <div class="card-name">${item.name}</div>
                    </div>
                    <div class="card-controls">
                        <button class="ctrl-btn" onclick="move('i', ${idx}, -1)">▲</button>
                        <button class="ctrl-btn ctrl-gear" onclick="openEditModal('i', ${idx})">⚙️</button>
                        <button class="ctrl-btn" onclick="move('i', ${idx}, 1)">▼</button>
                    </div>
                </div>`;
            });
        }
    };

    window.move = (type, idx, dir) => {
        let list = (type === 'f') ? state.folders : state.folders.find(f => f.id === currentFolderId).items;
        let newIdx = idx + dir;
        if (newIdx < 0 || newIdx >= list.length) return;
        [list[idx], list[newIdx]] = [list[newIdx], list[idx]];
        sync();
    };

    window.openEditModal = (type, idx) => {
        editingTarget = { type, idx };
        const data = (type === 'f') ? state.folders[idx] : state.folders.find(f => f.id === currentFolderId).items[idx];
        document.getElementById('edit-name').value = data.name;
        document.getElementById('edit-img').value = data.img || '';
        document.getElementById('edit-header').innerText = type === 'f' ? "Edit Location" : "Edit Item";
        document.getElementById('edit-modal').classList.add('active');
    };

    window.applyEdit = () => {
        const name = document.getElementById('edit-name').value;
        const img = document.getElementById('edit-img').value;
        if(!name) return;

        if (editingTarget.type === 'new_f') {
            state.folders.push({ id: Date.now(), name, img, items: [] });
        } else if (editingTarget.type === 'new_i') {
            const f = state.folders.find(f => f.id === currentFolderId);
            if (!f.items) f.items = [];
            f.items.push({ id: Date.now(), name, img });
        } else if (editingTarget.type === 'f') {
            state.folders[editingTarget.idx].name = name;
            state.folders[editingTarget.idx].img = img;
        } else if (editingTarget.type === 'i') {
            const f = state.folders.find(f => f.id === currentFolderId);
            f.items[editingTarget.idx].name = name;
            f.items[editingTarget.idx].img = img;
        }
        sync(); closeModals();
    };

    window.confirmDelete = () => {
        if (!confirm("Delete permanently?")) return;
        if (editingTarget.type === 'f') state.folders.splice(editingTarget.idx, 1);
        else state.folders.find(f => f.id === currentFolderId).items.splice(editingTarget.idx, 1);
        sync(); closeModals();
    };

    window.openAddModal = () => {
        editingTarget = { type: currentFolderId === null ? 'new_f' : 'new_i' };
        document.getElementById('edit-header').innerText = currentFolderId === null ? "New Location" : "New Item";
        document.getElementById('edit-name').value = '';
        document.getElementById('edit-img').value = '';
        document.getElementById('edit-modal').classList.add('active');
    };

    window.openFolder = (id) => { currentFolderId = id; render(); };
    window.goBack = () => { currentFolderId = null; render(); };
    window.closeModals = () => document.getElementById('edit-modal').classList.remove('active');
</script>
</body>
</html>
